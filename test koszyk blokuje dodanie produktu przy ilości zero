import time
import pytest
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

PRODUCT_URL = "http://www.selenium-shop.pl/produkt/koszulka-manchester-fc-city/"
CART_URL = "http://www.selenium-shop.pl/koszyk/"


@pytest.fixture
def driver():
    driver = webdriver.Chrome()
    driver.maximize_window()
    yield driver
    driver.quit()


def test_nie_mozna_dodac_produktu_z_zerowa_iloscia(driver):
    wait = WebDriverWait(driver, 10)

    # 1) Wejście na kartę produktu
    driver.get(PRODUCT_URL)

    # 2) Ustaw ilość = 0
    qty = wait.until(
        EC.visibility_of_element_located((By.CSS_SELECTOR, "input.qty"))
    )
    qty.clear()
    qty.send_keys("0")

    # 3) Kliknij "Dodaj do koszyka"
    add_btn = wait.until(
        EC.element_to_be_clickable((By.CSS_SELECTOR, "button.single_add_to_cart_button"))
    )
    add_btn.click()

    # ⏸️ PAUZA 5 SEKUND (świadomie)
    time.sleep(5)

    # 4) Sprawdź, że NIE pojawił się komunikat dodania do koszyka
    messages = driver.find_elements(By.CSS_SELECTOR, ".woocommerce-message")
    assert len(messages) == 0, "Produkt został dodany do koszyka mimo ilości 0"

    # 5) Dodatkowa weryfikacja: koszyk jest pusty
    driver.get(CART_URL)
    time.sleep(5)  # ⏸️ druga pauza, żeby zobaczyć koszyk

    cart_rows = driver.find_elements(
        By.CSS_SELECTOR, "tr.woocommerce-cart-form__cart-item"
    )
    assert len(cart_rows) == 0, "Koszyk nie jest pusty po próbie dodania 0 sztuk"
